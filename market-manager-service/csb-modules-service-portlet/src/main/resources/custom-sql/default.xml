<?xml version="1.0" encoding="UTF-8"?>
<custom-sql>
    <sql id="com.arman.csb.modules.service.MyBlogService.getGroupBlogs">
        <![CDATA[
        SELECT  distinct BlogsEntry.* , commentCNT.cnt as commentCount FROM BlogsEntry

        LEFT OUTER JOIN
        (
            SELECT AssetEntry.classPK, AssetCategory.name FROM AssetEntry

            INNER JOIN AssetEntries_AssetCategories  ON AssetEntries_AssetCategories.entryId = AssetEntry.entryId

            INNER JOIN AssetCategory ON AssetCategory.categoryId = AssetEntries_AssetCategories.categoryId
        ) AS cat ON BlogsEntry.entryId =cat.classPK

        LEFT OUTER JOIN
        (
            SELECT AssetEntry.classPK, AssetTag.name FROM AssetEntry

            INNER JOIN AssetEntries_AssetTags ON AssetEntries_AssetTags.entryId = AssetEntry.entryId

            INNER JOIN AssetTag ON AssetTag.tagId = AssetEntries_AssetTags.tagId
        ) AS tgs ON tgs.classPK = BlogsEntry.entryId

        LEFT OUTER JOIN
        (
            SELECT MBMessage.classPK , count(*) AS cnt FROM MBMessage GROUP BY classPK
        ) AS commentCNT ON commentCNT.classPK = BlogsEntry.entryId

        WHERE

            (cat.name IN (?) OR tgs.name in (?) OR ?=true) AND
            (BlogsEntry.groupId = ?) AND
            (BlogsEntry.status = ?)  AND
            (BlogsEntry.companyId = ?) AND
            (? IS NULL OR BlogsEntry.displayDate > ?) AND
            (? IS NULL OR BlogsEntry.displayDate < ?)


    ]]>
    </sql>


    <sql id="com.arman.csb.modules.service.CustomerService.search">
        <![CDATA[
            SELECT  distinct Customer.*  FROM CSBModules_Customer AS Customer

            WHERE
                (? IS NULL OR Customer.mentorCustomerId = ?) AND
                ((Customer.name like '##KEYWORD##') OR
                    (Customer.nationalCode like '##KEYWORD##') OR
                    (Customer.mobile like '##KEYWORD##') OR
                    (Customer.email like '##KEYWORD##'))
            ORDER BY Customer.createDate DESC

        ]]>
    </sql>


    <sql id="com.arman.csb.modules.service.ScoreService.customerScoresByDate">
        <![CDATA[
            SELECT  distinct sum(Score.value), date_trunc('day' , Score.createDate) FROM CSBModules_Customer AS Customer, CSBModules_Score AS Score
            WHERE
                Customer.id_ = Score.customerId AND Customer.id_ = ?
            GROUP BY
                date_trunc('day' , Score.createDate) , Customer.id_
            HAVING
                date_trunc('day' , Score.createDate) >= ? AND date_trunc('day' , Score.createDate) <= ?

            ORDER BY date_trunc('day' , Score.createDate) ASC

        ]]>
    </sql>

    <sql id="com.arman.csb.modules.service.ScoreService.scoresByDate">
        <![CDATA[
            SELECT  distinct sum(Score.value), date_trunc('day' , Score.createDate) FROM CSBModules_Score AS Score
            GROUP BY
                date_trunc('day' , Score.createDate)
            HAVING
                date_trunc('day' , Score.createDate) >= ? AND date_trunc('day' , Score.createDate) <= ?
            ORDER BY date_trunc('day' , Score.createDate) ASC
        ]]>
    </sql>
    <sql id="com.arman.csb.modules.service.ScoreService.scoresByMonth">
        <![CDATA[
            SELECT  distinct sum(Score.value), date_trunc('month' , Score.createDate) FROM CSBModules_Score AS Score
                WHERE Score.createDate >= ? AND Score.createDate <= ?
            GROUP BY
                date_trunc('month' , Score.createDate)
            ORDER BY date_trunc('month' , Score.createDate) ASC
        ]]>
    </sql>


    <sql id="com.arman.csb.modules.service.ScoreService.sumByCustomerAndType">
        <![CDATA[
            SELECT sum(Score.value) FROM CSBModules_Customer AS Customer, CSBModules_Score AS Score
            WHERE
                Customer.id_ = Score.customerId AND Customer.id_ = ? AND Score.type_ = ?   AND
                (? IS NULL OR Score.createDate > ?) AND
                (? IS NULL OR Score.createDate < ?)
            GROUP BY
                Customer.id_
        ]]>
    </sql>

    <sql id="com.arman.csb.modules.service.ScoreService.sumByType">
        <![CDATA[
            SELECT sum(Score.value) FROM CSBModules_Score AS Score
            WHERE
                (? = 0 OR Score.type_ = ?)   AND
                (? IS NULL OR Score.createDate > ?) AND
                (? IS NULL OR Score.createDate < ?)

        ]]>
    </sql>


    <sql id="com.arman.csb.modules.service.InvoiceService.search">
        <![CDATA[
            SELECT
                customer.name, invoice.createDate, itemData.numberOfItem, itemData.totalCost, itemData.totalScore,
                invoice.status, invoice.id_
            FROM CSBModules_Invoice AS invoice
            INNER JOIN
                CSBModules_Customer as customer
            ON invoice.customerid = customer.id_
            LEFT OUTER JOIN
                (SELECT item.invoiceId, COUNT(item.id_) AS numberOfItem, SUM(item.number_ * product.basePrice) AS totalCost,
                    SUM(item.number_ * product.score) AS totalScore
                FROM CSBModules_InvoiceItem AS item
                INNER JOIN CSBModules_Product as product ON product.id_ = item.productId
                GROUP BY item.invoiceId)
            AS itemData ON itemData.invoiceId = invoice.id_
            WHERE
                (
                    (invoice.address like '##KEYWORD##') OR
                    (invoice.telephone like '##KEYWORD##') OR
                    (invoice.mobile like '##KEYWORD##')
                ) AND
                (
                    (? OR invoice.status = ?) AND
                    (? OR invoice.createDate >= ?) AND
                    (? OR invoice.createDate <= ?) AND
                    (? OR invoice.customerId = ?)
                ) AND
                (
                    (invoice.groupId = ?)
                )
            ORDER BY invoice.createDate DESC
        ]]>
    </sql>

    <sql id="com.arman.csb.modules.service.InvoiceService.count">
        <![CDATA[
            SELECT
                count(invoice.id_)
            FROM CSBModules_Invoice AS invoice
            INNER JOIN
                CSBModules_Customer as customer
            ON invoice.customerid = customer.id_
            LEFT OUTER JOIN
                (SELECT item.invoiceId, COUNT(item.id_) AS numberOfItem, SUM(item.number_ * product.basePrice) AS totalCost,
                    SUM(item.number_ * product.score) AS totalScore
                FROM CSBModules_InvoiceItem AS item
                INNER JOIN CSBModules_Product as product ON product.id_ = item.productId
                GROUP BY item.invoiceId)
            AS itemData ON itemData.invoiceId = invoice.id_
            WHERE
                (
                    (invoice.address like '##KEYWORD##') OR
                    (invoice.telephone like '##KEYWORD##') OR
                    (invoice.mobile like '##KEYWORD##')
                ) AND
                (
                    (? OR invoice.status = ?) AND
                    (? OR invoice.createDate >= ?) AND
                    (? OR invoice.createDate <= ?) AND
                    (? OR invoice.customerId = ?)
                ) AND
                (
                    (invoice.groupId = ?)
                )
        ]]>
    </sql>

    <sql id="com.arman.csb.modules.service.PaymentService.paymentsByDate">
        <![CDATA[
                SELECT  distinct sum(Payment.amount), date_trunc('day' , Payment.createDate) FROM CSBModules_Payment AS Payment
                GROUP BY
                    date_trunc('day' , Payment.paymentDate)
                HAVING
                    date_trunc('day' , Score.paymentDate) >= ? AND date_trunc('day' , Payment.paymentDate) <= ?
                ORDER BY date_trunc('day' , Payment.paymentDate) ASC
            ]]>
    </sql>

    <sql id="com.arman.csb.modules.service.InvoiceItemService.search">
        <![CDATA[
            SELECT
                *
            FROM CSBModules_InvoiceItem AS item
            INNER JOIN
                CSBModules_Product as product
            On product.id_ = item.productId
            WHERE
                (
                    (product.name like '##KEYWORD##') OR
                    (product.code_ like '##KEYWORD##')
                ) AND
                (item.invoiceId = ?)
            ORDER BY item.createDate DESC
        ]]>
    </sql>

    <sql id="com.arman.csb.modules.service.UserActivity.search">
        <![CDATA[
            SELECT
                *
            FROM CSBModules_UserActivity AS activity
            WHERE
                (
                    (activity.userName like '##KEYWORD##') OR
                    (activity.data_ like '##KEYWORD##')
                ) AND
                (
                    (? OR activity.entity = ?) AND
                    (? OR activity.action = ?) AND
                    (? OR activity.importance = ?) AND
                    (? OR activity.createDate >= ?) AND
                    (? OR activity.createDate <= ?)
                ) AND
                (
                    activity.groupId = ?
                )

            ORDER BY activity.createDate DESC
        ]]>
    </sql>

    <sql id="com.arman.csb.modules.service.UserActivity.count">
        <![CDATA[
            SELECT
                count(activity.id_)
            FROM CSBModules_UserActivity AS activity
            WHERE
                (
                    (activity.userName like '##KEYWORD##') OR
                    (activity.data_ like '##KEYWORD##')
                ) AND
                (
                    (? OR activity.entity = ?) AND
                    (? OR activity.action = ?) AND
                    (? OR activity.importance = ?) AND
                    (? OR activity.createDate >= ?) AND
                    (? OR activity.createDate <= ?)
                ) AND
                (
                    activity.groupId = ?
                )
        ]]>
    </sql>


    <sql id="com.arman.csb.modules.service.Product.search">
        <![CDATA[
            SELECT
                *
            FROM CSBModules_Product AS product
            WHERE
                (
                    (product.name like '##KEYWORD##') OR
                    (product.code_ like '##KEYWORD##') OR
                    (product.userName like '##KEYWORD##')
                ) AND
                (
                    (? OR product.status = ?)
                ) AND
                (
                    product.groupId = ?
                )
            ORDER BY product.createDate DESC
        ]]>
    </sql>

    <sql id="com.arman.csb.modules.service.Instance.search">
        <![CDATA[
            SELECT
                *
            FROM CSBModules_Instance AS instance
            WHERE
                (
                    (instance.name like '##KEYWORD##') OR
                    (instance.url like '##KEYWORD##')
                ) AND
                (
                    (? OR instance.status = ?)
                )
            ORDER BY instance.createDate DESC
        ]]>
    </sql>

</custom-sql>